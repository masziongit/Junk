{"version":3,"sources":["../../src/api/prospect_profile.js"],"names":["util","config_func","config","db","logger","api","errRes","errObj","allfield","field","all","reqfield","req","oracledb","require","post","validate","res","errors","isEmpty","error","badRequest","status","json","param","oname","body","includes","value","isValid","length","endsWith","sql","dabaseTable","prospect_profile","debug","params","prospect_id","type","NUMBER","dir","BIND_OUT","create_date","DATE","execute","then","r","outBinds","Object","assign","commit","beautifyResponse","info","catch","e","rollback","internalServerError","get","id","extractId","prospect_profile_get","toString","outFormat","OBJECT","rows","changeStatusToExpired","notFound","invParam","exists","array","msg","condition","mobile_no","mobileNo","citizen_id","citizenId","passport_no","passportNo","firstname_en","lastname_en","firstNameEn","lastNameEn","firstname_th","lastname_th","firstNameTh","lastNameTh","JSON","parse","stringify","_","map","reject","prospect_status","put","prospectId","setfields","update_date","tz","format","delete","prospect_profile_delete","split","parseInt","transform","result","val","key","toLowerCase","object","prospect","now","Array","forEach","expired","o","createDate","moment","diff","expire_day"],"mappings":"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","file":"prospect_profile.js","sourcesContent":["/* eslint-disable no-mixed-spaces-and-tabs,valid-typeof */\r\nimport {version} from '../../package.json'\r\nimport {Router} from 'express'\r\nimport {check, oneOf, validationResult} from 'express-validator/check'\r\nimport empty from 'is-empty'\r\nimport * as util from '../lib/util.js'\r\nimport {prospect_profile_delete, prospect_profile_get} from './sql.js'\r\nimport moment from 'moment-timezone'\r\nimport _ from 'lodash';\r\nimport pad from 'pad-number';\r\n\r\nlet config_func;\r\n\r\nexport default ({config, db,logger}) => {\r\n\r\n    let api = Router();\r\n    const errRes = config.errObj\r\n    const allfield = config.field.all\r\n    const reqfield = config.field.req\r\n    const oracledb = require('oracledb');\r\n\r\n    config_func = config;\r\n\r\n    api.post('/', util.validate(reqfield),\r\n        (req, res) => {\r\n            // logger.debug(`Get Request body : ${JSON.stringify(req.body)}`)\r\n\r\n            const errors = validationResult(req);\r\n            if (!errors.isEmpty()) {\r\n                logger.error(errRes.badRequest)\r\n                return res.status(400).json(errRes.badRequest);\r\n            }\r\n\r\n            let field = ''\r\n            let param = ''\r\n\r\n            for (let oname in req.body) {\r\n\r\n                if (allfield.includes(oname)){\r\n\r\n                    field += oname + ','\r\n                    let value = req.body[oname]\r\n\r\n                    if (moment(value, 'YYYY-MM-DD').isValid() && value.length == 10) {\r\n                        param += `TO_DATE('${value}','YYYY-MM-DD')`\r\n                    } else if (oname.endsWith('_flag')) {\r\n                        param += (value ? 1 : 0)\r\n                    } else {\r\n                        param += value==null?null:`'${value}'`\r\n                    }\r\n\r\n                    param += ','\r\n\r\n                }else {\r\n                    delete req.body[oname];\r\n                }\r\n\r\n            }\r\n\r\n            field = field + `CREATE_DATE , UPDATE_DATE`\r\n            param = param + `SYSDATE,SYSDATE`\r\n\r\n            let sql = `INSERT INTO ${config.dabaseTable.prospect_profile} (${field}) \r\n                        VALUES (${param}) \r\n                        RETURNING PROSPECT_ID,CREATE_DATE INTO :prospect_id,:create_date`\r\n\r\n            logger.debug(`Sql : ${sql}`)\r\n            //${Math.floor(Math.random() * Math.pow(10, 7))},\r\n            let params = {\r\n                prospect_id: {type: oracledb.NUMBER, dir: oracledb.BIND_OUT},\r\n                create_date: {type: oracledb.DATE, dir: oracledb.BIND_OUT}\r\n            }\r\n            db.execute(sql, params)\r\n                .then((r) => {\r\n                    let json = {\r\n                        prospect_id: r.outBinds.prospect_id[0],\r\n                        create_date: r.outBinds.create_date[0]\r\n                    }\r\n                    Object.assign(json,req.body)\r\n\r\n                    db.commit()\r\n                    res.status(200).json(beautifyResponse(json))\r\n\r\n                    logger.info(`Insert data complete!!`)\r\n                    // //logger.debug(`Send Response body : ${JSON.stringify(json)}`)\r\n                })\r\n                .catch((e) => {\r\n                    db.rollback()\r\n                    res.status(500).json(errRes.internalServerError);\r\n                    logger.error(e)\r\n                    throw e\r\n                })\r\n        });\r\n\r\n    api.get('/:id', (req, res) => {\r\n\r\n        // logger.debug(`Get Request body : ${JSON.stringify(req.body)}`)\r\n\r\n        if (!empty(req.params.id)) {\r\n            const id = extractId(req.params.id)\r\n\r\n            logger.debug(`Sql: ${prospect_profile_get}`)\r\n            logger.debug(`prospect_id : ${id}`)\r\n\r\n            db.execute(prospect_profile_get, [id.toString()], {outFormat: oracledb.OBJECT})\r\n                .then((r) => {\r\n                    if (!empty(r.rows)) {\r\n                        let json = beautifyResponse(r.rows[0])\r\n                        json = changeStatusToExpired(json,logger)\r\n                        res.status(200).json(json)\r\n\r\n                        logger.info(`Search Data complete!!`)\r\n                        // //logger.debug(`Send Response body : ${JSON.stringify(json)}`)\r\n                    } else {\r\n                        res.status(404).json(errRes.notFound)\r\n                        logger.error(errRes.notFound)\r\n                    }\r\n                }).catch((e) => {\r\n                res.status(500).json(errRes.internalServerError)\r\n                logger.error(e)\r\n                throw e\r\n            })\r\n\r\n        }\r\n        else {\r\n            res.status(400).json(errRes.invParam)\r\n            logger.error(errRes.invParam)\r\n        }\r\n    });\r\n\r\n    api.post('/search',\r\n        oneOf([check('mobile_no').exists(),\r\n            check('citizen_id').exists(),\r\n            check('passport_no').exists(),\r\n            check('firstname_en').exists(),\r\n            check('lastname_en').exists(),\r\n            check('firstname_th').exists(),\r\n            check('lastname_th').exists()]),\r\n        (req, res) => {\r\n\r\n            // logger.debug(`Get Request body : ${JSON.stringify(req.body)}`)\r\n\r\n            const errors = validationResult(req);\r\n            if (!errors.isEmpty()) {\r\n                logger.error(errors.array()[0].msg)\r\n                return res.status(400).json(errRes.badRequest);\r\n            }\r\n            let sql = `SELECT * FROM prospect_profile p WHERE 1=1`;\r\n            let condition = {};\r\n            if (req.body.mobile_no != null) {\r\n                sql += \" AND p.mobile_no = :mobileNo\";\r\n                Object.assign(condition, {mobileNo: req.body.mobile_no});\r\n            }\r\n            if (req.body.citizen_id != null) {\r\n                sql += \" AND p.citizen_id = :citizenId\";\r\n                Object.assign(condition, {citizenId: req.body.citizen_id});\r\n            }\r\n            if (req.body.passport_no != null) {\r\n                sql += \" AND p.passport_no = :passportNo\";\r\n                Object.assign(condition, {passportNo: req.body.passport_no});\r\n            }\r\n            if (req.body.firstname_en != null && req.body.lastname_en != null) {\r\n                sql += \" AND p.firstname_en LIKE :firstNameEn AND p.lastname_en LIKE :lastNameEn\";\r\n                Object.assign(condition, {\r\n                    firstNameEn: req.body.firstname_en + \"%\",\r\n                    lastNameEn: req.body.lastname_en + \"%\"\r\n                })\r\n            }\r\n            if (req.body.firstname_th != null && req.body.lastname_th != null) {\r\n                sql += \" AND p.firstname_th LIKE :firstNameTh AND p.lastname_th LIKE :lastNameTh\";\r\n                Object.assign(condition, {\r\n                    firstNameTh: req.body.firstname_th + \"%\",\r\n                    lastNameTh: req.body.lastname_th + \"%\"\r\n                })\r\n            }\r\n\r\n            sql += \" ORDER BY UPDATE_DATE DESC\";\r\n\r\n            logger.debug(`Sql: ${sql}`)\r\n\r\n            db.execute(sql, condition, {outFormat: oracledb.OBJECT})\r\n                .then((r) => {\r\n                    if (!empty(r)) {\r\n                        let json = JSON.parse(JSON.stringify(r.rows))\r\n                        json = _.map(json, beautifyResponse);\r\n                        json = changeStatusToExpired(json,logger);\r\n                        json = _.reject(json, {prospect_status: 'EXPIRED'});\r\n                        if (json.length < 1){\r\n                            res.status(200).json({msg:\"All data is EXPIRED\"})\r\n                        } else {\r\n                            res.status(200).json(json)\r\n                        }\r\n\r\n                        logger.info(`Search Data complete!!`)\r\n                        //logger.debug(`Send Response body : ${JSON.stringify(json)}`)\r\n\r\n                    } else {\r\n                        res.status(404).json(errRes.notFound)\r\n                        logger.error(errRes.notFound)\r\n                    }\r\n                }).catch((e) => {\r\n                res.status(500).json(errRes.internalServerError)\r\n                logger.error(e)\r\n                throw e\r\n            })\r\n        });\r\n\r\n    api.put('/:id',oneOf(util.validate(allfield)),\r\n        (req, res) => {\r\n\r\n        // logger.debug(`Get Request body : ${JSON.stringify(req.body)}`)\r\n        const errors = validationResult(req);\r\n\r\n        // Validate request body\r\n        if (!errors.isEmpty()) {\r\n            logger.error(errRes.badRequest)\r\n            return res.status(400).json(errRes.badRequest);\r\n        }\r\n        // Validate url\r\n        if (empty(req.params.id)) {\r\n            logger.error(errRes.invParam)\r\n            return res.status(400).json(errRes.invParam)\r\n        }\r\n        let prospectId = extractId(req.params.id);\r\n\r\n        let setfields = ''\r\n\r\n        for (let oname in req.body) {\r\n\r\n            if (allfield.includes(oname)) {\r\n\r\n                let value = `${req.body[oname]}`\r\n\r\n                if (moment(value, 'YYYY-MM-DD').isValid() && value.length == 10) {\r\n                    value = `TO_DATE('${value}','YYYY-MM-DD')`\r\n                } else if (oname.endsWith('_flag')) {\r\n                    value = value ? 1 : 0\r\n                } else if (value == 'null') {\r\n                    value = null\r\n                } else {\r\n                    value = `'${value}'`\r\n                }\r\n\r\n                setfields += `${oname} = ${value},`\r\n            }else {\r\n                delete req.body[oname];\r\n            }\r\n        }\r\n\r\n        setfields += `UPDATE_DATE = SYSDATE`\r\n\r\n        let sql = `UPDATE  ${config.dabaseTable.prospect_profile} SET ${setfields} WHERE PROSPECT_ID = ${prospectId}`\r\n\r\n        logger.debug(`Sql : ${sql}`)\r\n\r\n        db.execute(sql)\r\n            .then((r) => {\r\n\r\n                let json = {\r\n                    prospect_id: prospectId,\r\n                    update_date: moment().tz(\"Asia/Bangkok\").format('YYYY-MM-DD HH:mm:ss')\r\n                }\r\n                Object.assign(json,req.body)\r\n\r\n                db.commit()\r\n                res.status(200).json(beautifyResponse(json))\r\n\r\n                logger.info(`Update data complete!!`)\r\n                //logger.debug(`Send Response body : ${JSON.stringify(json)}`)\r\n            })\r\n            .catch((e) => {\r\n                db.rollback()\r\n                res.status(500).json(errRes.internalServerError);\r\n                logger.error(e)\r\n                throw e\r\n\r\n            })\r\n\r\n    });\r\n\r\n    api.delete('/:id', (req, res) => {\r\n\r\n        // logger.debug(`Get Request body : ${JSON.stringify(req.body)}`)\r\n\r\n        if (!empty(req.params.id)) {\r\n            const id = extractId(req.params.id)\r\n\r\n            logger.debug(`Sql: ${prospect_profile_delete}`)\r\n            logger.debug(`prospectId : ${id}`)\r\n\r\n            db.execute(prospect_profile_delete, [id])\r\n                .then((r) => {\r\n\r\n                    db.commit()\r\n                    let json = {prospect_id: id}\r\n                    res.status(200).json(beautifyResponse(json))\r\n\r\n                    logger.info(`Delete data complete!!`)\r\n                    //logger.debug(`Send Response body : ${JSON.stringify(json)}`)\r\n\r\n                }).catch((e) => {\r\n                db.rollback()\r\n                res.status(500).json(errRes.internalServerError)\r\n                logger.error(e)\r\n                throw e\r\n            })\r\n\r\n        }\r\n        else {\r\n            res.status(400).json(errRes.invParam)\r\n            logger.error(errRes.invParam)\r\n        }\r\n    });\r\n    return api\r\n}\r\n\r\nlet extractId = (id) => {\r\n    let split = id.split(/P\\d{4}/)\r\n\r\n    if (split.length != 2) {\r\n        return \"\";\r\n    }\r\n    return parseInt(split[1]);\r\n}\r\n\r\nlet beautifyResponse = (json) => {\r\n    json = _.transform(json, (result, val, key) => {\r\n        result[key.toLowerCase()] = val;\r\n        if (key.toLowerCase().endsWith('_flag')) {\r\n            result[key.toLowerCase()] = val==='true' ? true : false\r\n        }\r\n        if(val==null){\r\n            result[key.toLowerCase()] = ''\r\n        }\r\n        if(key.toLowerCase().endsWith('_date')){\r\n            result[key.toLowerCase()] = moment(val).format(\"YYYY-MM-DD\")\r\n        }\r\n    });\r\n    json.prospect_id = `P${moment(json.create_date).format(\"YYMM\")}${pad(parseInt(json.prospect_id), 7)}`;\r\n    return json;\r\n}\r\n\r\n\r\nlet changeStatusToExpired = (object,logger) => {\r\n    let prospect = JSON.parse(JSON.stringify(object));\r\n    const now = moment().tz(\"Asia/Bangkok\");\r\n\r\n    if (prospect instanceof  Array){\r\n        prospect.forEach(o=>{\r\n            expired(now,o,logger)\r\n        })\r\n    } else {\r\n        expired(now,prospect,logger)\r\n    }\r\n\r\n    return prospect\r\n}\r\n\r\nlet expired = (now,o,logger)=>{\r\n    let createDate = moment.tz(o.create_date, \"Asia/Bangkok\")\r\n    if (now.diff(createDate, \"days\") >= config_func.expire_day) {\r\n        o.prospect_status = \"EXPIRED\"\r\n        logger.info(`This Data is EXPIRED`)\r\n        logger.debug(`Data : ${JSON.stringify(o)}`)\r\n    }\r\n}\r\n"]}